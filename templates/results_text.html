<!doctype html><meta charset="utf-8">
<title>텍스트 검색 결과</title>
<style>
  body{font-family:system-ui,Malgun Gothic,sans-serif;max-width:1000px;margin:auto;padding:24px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .card{border:1px solid #ddd;border-radius:12px;padding:10px}
  img{width:100%;height:180px;object-fit:cover;border-radius:8px}
  small{color:#666}
  .like{cursor:pointer;border:1px solid #ccc;border-radius:8px;padding:6px 10px;background:#fafafa}
  .liked{background:#ffe7ef;border-color:#ff6b9a}
  .topbar a{margin-right:12px}
</style>
<div class="topbar">
  <a href="/">← 검색 창으로 돌아가기</a>
  <a href="/favorites">♥ 즐겨찾기</a>
</div>

<h2>텍스트 검색 결과</h2>
<p>입력한 텍스트: <b>{{ query }}</b></p>
{% if max_sim is not none %}
  <p style="color:#666">내부 최대 유사도: {{ '%.4f'|format(max_sim) }}</p>
{% endif %}

{% if results %}
  <div class="grid">
    {% for r in results %}
      <div class="card" data-mid="{{ r.mongo_id }}" data-fn="{{ r.filename }}">
        <img src="/mongo/{{ r.mongo_id }}" alt="{{ r.filename }}">
        <div><b>#{{ r.rank }}</b> {{ r.filename }}</div>
        {% if r.score is not none %}
          <div><small>similarity: {{ '%.4f'|format(r.score) }}</small></div>
        {% endif %}
        <button class="like {{ 'liked' if r.liked else '' }}">{{ '♥ 저장됨' if r.liked else '♡ 저장' }}</button>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>내부 데이터셋에서 일치 항목이 없어요.</p>
{% endif %}

<script>
async function toggleLike(card, liked){
  const mongo_id = card.dataset.mid, filename = card.dataset.fn;
  const url = liked ? "/unlike" : "/like";
  const res = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({mongo_id, filename})
  });
  const j = await res.json();
  if(j.ok){
    const btn = card.querySelector('.like');
    if(liked){ btn.classList.remove('liked'); btn.textContent='♡ 저장'; }
    else     { btn.classList.add('liked');    btn.textContent='♥ 저장됨'; }
  } else { alert(j.msg || "오류"); }
}
document.querySelectorAll('.card .like').forEach(btn=>{
  btn.addEventListener('click', e=>{
    const card = e.target.closest('.card');
    toggleLike(card, e.target.classList.contains('liked'));
  });
});
</script>
